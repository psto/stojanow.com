---
import { format } from 'date-fns';
const { TweetID } = Astro.props;

const BearerToken = import.meta.env.PUBLIC_TWITTER_BEARER_TOKEN;
const jsonURL1 = 'https://api.twitter.com/2/tweets?ids=';
const jsonURL2 =
  '&expansions=author_id,attachments.media_keys&tweet.fields=created_at,text,attachments,entities,source&user.fields=name,username,profile_image_url&media.fields=preview_image_url,type,url,alt_text';

const response = await fetch(jsonURL1 + TweetID + jsonURL2, {
  method: 'get',
  headers: {
    Authorization: `Bearer ${BearerToken}`,
  },
});
const Json = await response.json();
const JsonData = Json.data[0];
const JsonIncludes = Json.includes;

let text = '';
let created_at = '';
let profile_image_url = '';
let name = '';
let username = '';

name = JsonIncludes.users[0].name;
username = JsonIncludes.users[0].username;
profile_image_url = JsonIncludes.users[0].profile_image_url;
created_at = JsonData.created_at;

text = JsonData.text;

if (JsonData.entities?.urls) {
  JsonData.entities.urls.forEach((url) => {
    if (!url.images) {
      if (!url.unwound_url) {
        if (url.display_url.includes('buff.ly')) {
          text = text.replace(
            url.url,
            `<a href=${url.url} rel="noreferrer noopener">${url.display_url}</a>`,
          );
        } else {
          text = text.replace(url.url, ``);
        }
      } else {
        text = text.replace(
          url.url,
          `<a href=${url.url} rel="noreferrer noopener">${url.display_url}</a>`,
        );
      }
    } else {
      text = text.replace(
        url.url,
        `<a href=${url.url} rel="noreferrer noopener">${url.display_url}</a>`,
      );
    }
  });
}

if (JsonData.entities?.mentions) {
  JsonData.entities.mentions.forEach((mention) => {
    text = text.replace(
      `@${mention.username}`,
      `<a rel="noreferrer noopener" href="https://twitter.com/${mention.username}">@${mention.username}</a>`,
    );
  });
}

if (JsonData.entities?.hashtags) {
  JsonData.entities.hashtags.forEach((hashtag) => {
    text = text.replace(
      `#${hashtag.tag}`,
      `<a rel="noreferrer noopener" href="https://twitter.com/hashtag/${hashtag.tag}?src=hash&ref_src=twsrc">#${hashtag.tag}</a>`,
    );
  });
}

text = text.replace(/(?:\r\n|\r|\n)/g, '<br/>');

let imageItems = '';

if (JsonIncludes.media) {
  JsonIncludes.media.forEach((item) => {
    if (item.url) {
      imageItems = imageItems + `<img class="tweet-img" src=${item.url} alt="" /><br />`;
    }
  });
}
---

<div class="astro__tweet">
  <div class="astro__tweet-header">
    <a href={`https://twitter.com/${username}`} rel="noreferrer noopener">
      <img
        src={profile_image_url}
        alt={`Twitter avatar for ${username}`}
        class="astro__tweet-header-profile-picture"
      />
    </a>
    <div class="astro__tweet-header-names">
      <a
        href={`https://twitter.com/${username}`}
        rel="noreferrer noopener"
        class="astro__tweet-header-names-full"
        >{name}
      </a>
      <a
        class="astro__tweet-header-names-username"
        href={`https://twitter.com/${username}`}
        rel="noreferrer noopener"
        >@{username}
      </a>
    </div>
  </div>
  <p class="astro__tweet-body" set:html={text}></p>
  <span set:html={imageItems}></span>
  <div class="tweet-footer">
    <a
      href={`https://twitter.com/${username}/status/${TweetID}`}
      class="astro__tweet-date"
      rel="noreferrer noopener"
      >{format(new Date(created_at), 'MMMM d, yyyy â€¢ h:mm aa')}
    </a>
  </div>
</div>

<style>
  .astro__tweet {
    display: flex;
    flex-direction: column;
    background: white;
    max-width: 500px;
    font-size: 0.75em;
    line-height: 1.35em;
    border-radius: 5px;
    margin: 0 auto;
    min-height: 60px;
    padding: 0px;
    border: 1px solid #efefef;
  }
  .astro__tweet:hover {
    border: 1px solid #e7e7e7;
  }
  .astro__tweet-media {
    position: relative;
    overflow: hidden;
  }
  .astro__tweet-media img {
    width: 100%;
    left: 0;
    right: 0;
    margin: auto;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
  }
  .astro__tweet-header {
    padding: 1rem;
    display: flex;
  }
  .astro__tweet-header-profile-picture {
    height: 40px;
    min-height: 40px;
    width: 40px;
    border-radius: 50px;
    background-color: #ececec;
    margin: 0;
  }
  .astro__tweet-header-names {
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin: 0 1rem;
    flex: 1 0 auto;
  }
  .astro__tweet-header-names-full {
    color: #1c2022;
    font-weight: bold;
    font-size: 16px;
  }
  .astro__tweet-header-names-username {
    color: #697882;
    font-size: 14px;
  }
  .astro__tweet-header-twitter-logo {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .astro__tweet-body {
    padding: 0 1rem 1rem;
    color: #1c2022;
    font-size: 16px;
    line-height: 22px;
  }
  .astro__tweet-date {
    font-size: 14px;
    color: #697882;
    padding: 0 1rem;
  }
  .astro__tweet-actions {
    display: flex;
    color: #aab8c2;
    font-size: 14px;
  }
  .astro__tweet-actions-button {
    padding: 1rem;
  }
</style>
